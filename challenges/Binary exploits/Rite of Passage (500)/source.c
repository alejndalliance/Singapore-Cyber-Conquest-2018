#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int permissionToSeeTheCyberKing;
char * showKey;

void game_over();
void south();
void east();
void north();

int main(int argc, char **argv) {

    showKey = malloc(0x10);
    strcpy(showKey, "echo the Key is locked");

    printf("You find yourself in the halls of the Cyber King. There are three exits:\n\n");
    
    printf("north, towards the throne room.\n");
    printf("south, to the exit\n");
    printf("east, to the hex wizard.\n");
    
    printf("Which direction do you want to go: ");
    
    char input[32] = {0};
    gets(input);
    
    if ( strcmp( input, "north" ) == 0 )
    {       
        north();
    }
    else if ( strcmp( input, "south" ) == 0 )
    {       
        south();
    }
    else if ( strcmp( input, "east" ) == 0 )
    {       
        east(0);
    }
    else
    {
        printf("You walk into a wall and knock yourself out. GAME OVER.\n");
    }
       
    return 0;
}

void north() 
{
    int (*system_func)(const char*) = system;

    if(permissionToSeeTheCyberKing)
    {
        system_func(showKey);
    }
    else
    {
        printf("The hex wizard appears in a puff of assembly and screeches \"Nobody sees the Cyber King! Not nobody, not no how!\". GAME OVER.\n");
    }
}

void game_over()
{
  exit(0);
}

void south() 
{
    printf("You abandon your attempt to see the Cyber King and head home...\n");
    sleep(5);
    printf("You arrive back at your home village to find a letter! You open it...\n");
    sleep(1);
    printf("Your request to see the king was granted! But now you've missed your appointment :-(\nGAME OVER\n");

    game_over();

    permissionToSeeTheCyberKing = 1;
}

void east(int hexLevel)
{
    int i = 0;
    printf("The hex wizard standing here is clearly crazy. He throws a giant bucket of opcodes at you.\n");

    if(hexLevel == 0x1337)
    {
        // unlock the key
        strncpy(showKey, "\x54\x56\x43\x17\x5c\x52\x4e\x19\x43\x4f\x43\x37", 12);
        char keyKey = hexLevel & 0xFF;
        for(i = 0; i < 12; i++)
        {
            showKey[i] = showKey[i] ^ keyKey;
        }

        printf("You absorb the hex, and for one glorious moment you understand everything. The hex wizard looks furious.\n");
        printf("\"You win this round, but unless you can get to the throne room immediately, you may find the odds STACKED against you! ahahaha!\"\n");
    }
    else
    {
        printf("You are too much of a n00b to understand the hex. The raw bytes drive you mad. GAME OVER.\n");
    }
}

